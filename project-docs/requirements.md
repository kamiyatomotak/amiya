# Chrona Bot 要件と機能

## 1. システム要件

*   **実行環境:** GitHub Actions 上の Docker コンテナ (Ubuntu 22.04 LTS ベース)
*   **プログラミング言語:** Python 3.9 以上
*   **外部 API:**
    *   X API v2 (Free プラン, OAuth 1.0a User Context 認証)
    *   Google Gemini API (`gemini-2.0-flash` モデル)
*   **認証情報 (環境変数 / GitHub Secrets):**
    *   `X_API_KEY`
    *   `X_API_SECRET`
    *   `X_ACCESS_TOKEN`
    *   `X_ACCESS_TOKEN_SECRET`
    *   `GEMINI_API_KEY`
    *   (`X_BEARER_TOKEN` は現在不使用)

## 2. 機能説明

### 2.1. 年の進行状況計算

*   **入力:** 現在の日時
*   **処理:**
    1.  現在の年を取得する。
    2.  その年の総日数を計算する (閏年を考慮)。
    3.  年初から現在までの経過日数を計算する。
    4.  進行率 (%) を計算する (経過日数 / 総日数 * 100)。
*   **出力:** 経過日数、総日数、進行率 (%)

### 2.2. テキストメーター生成

*   **入力:** 進行率 (%)
*   **処理:**
    1.  進行率に基づいて、20個のブロックからなるテキストメーターを生成する。
    2.  塗りつぶし記号: "█"
    3.  空白記号: "-"
    4.  メーターの末尾に進行率の整数部分 (%) を表示する (例: `[████------] 45%`)
*   **出力:** テキストメーター文字列

### 2.3. 示唆に富む一文生成 (Gemini API)

*   **入力:** 事前に定義されたプロンプト (日本語での出力、Xの文字数制限、時間の経過に関する示唆、ニュートラルなトーンを指示)
*   **処理:**
    1.  Google Gemini API (gemini-2.0-flash モデル) を呼び出す。
    2.  API から生成されたテキストを取得する。
*   **出力:** 生成された一文 (文字列)
*   **エラー時:** API 呼び出しに失敗した場合、事前に定義された固定の代替文言を返す。

### 2.4. Xへの自動投稿

*   **入力:** 経過日数、総日数、進行率 (%)、テキストメーター、生成された (または代替の) 一文、残り日数
*   **処理:**
    1.  指定されたフォーマットに従い、ツイート本文を組み立てる。
        ```
        本日は{年}年{月}月{日}日（{曜日}）

        ⏳ 経過日数：{current_day}日 / {total_days}日（残り{remaining_days}日）
        📈 進行度：{progress_bar}

        {generated_sentence}
        ```
    2.  X API v2 (OAuth 1.0a) を使用して、組み立てた本文をツイートとして投稿する。
*   **トリガー:** GitHub Actions のスケジュール (毎日 23:00 UTC / 日本時間 08:00)
*   **エラー時:** 投稿に失敗した場合、エラー情報をログに出力する。

## 3. ビジネスルール

*   投稿は毎日1回、指定された時間に必ず実行される。
*   年の計算は実行時の年を基準とする (例: 2024年実行時は2024年の、2025年実行時は2025年の進行度を計算)。
*   ツイート内容は常に指定されたフォーマットに従う。
*   Gemini API で生成される文章は、毎回異なる。

## 4. エッジケース

*   **年初 (1月1日):** 経過日数は1日、進行率は非常に低い値になる。
*   **年末 (12月31日):** 経過日数は総日数と同じ、進行率は100%になる。
*   **閏年:** 2月29日を含む年は、総日数が366日として計算される。
*   **API キーの無効化:** X API や Gemini API のキーが無効になった場合、処理は失敗し、エラーログが出力される。
*   **GitHub Actions の障害:** GitHub Actions 自体に障害が発生した場合、実行が遅延または失敗する可能性がある。
*   **Gemini API の応答遅延/タイムアウト:** タイムアウトが発生した場合、代替文言が使用される。
*   **X API のレート制限:** (現状の頻度では考えにくいが) 万が一レート制限に達した場合、投稿は失敗し、エラーログが出力される。 